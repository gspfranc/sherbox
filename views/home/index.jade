!!! 5
html
  head
    title Sherbox #{hello}
    link(href="/css/bootstrap.css" rel="stylesheet")
    link(href="/css/style.css" rel="stylesheet")
    script(src="/js/jquery.js")
    script(src="/js/bootstrap.js")
    script(src="/js/sjcl.js")
  body
    div.container
      div.page-header
        h1 Sherbox <small>securly share your files</small>
        h4 Box : <a id="box"></a>

      div.row
        div#dropbox.well.col-md-10.col-md-offset-1
          h2 Drag and drop files here

      div.row
        ul#list.list-inline
          - each file in files
            li
              a.file.well(id="#{file.box}", href="#") #{file.name}

      div#data
        - each file in files
          div(id="data-#{file.box}") #{file.crypt}
    script.
      function handleFiles(files) {
        for (var i = 0, f; f = files[i]; i++) {
          var file = files[i];
          var reader = new FileReader();
          reader.readAsBinaryString(file);

          reader.onloadend = function(evt) {
            var crypt = sjcl.encrypt("password", reader.result);
            var item = $('<li class="well">');
            var link = $('<a>');

            link.attr('href', '#');
            link.attr('html', file.name);
            item.append(link);

            $("#list").append(item);

            $('#data').append(dev)

            $.post("/put", { 
              crypt: crypt, 
              name: file.name,
              box: box
              }, function(data) {
                console.log(data);
              }, "json");
          }
        }
      }

      function dragenter(e) {
        e.stopPropagation();
        e.preventDefault();
      }

      function dragover(e) {
        e.stopPropagation();
        e.preventDefault();
      }

      function handleFileSelect(e) {
        e.stopPropagation();
        e.preventDefault();

        var files = e.target.files; // FileList object
        handleFiles(files);
      }

      function drop(e) {
        e.stopPropagation();
        e.preventDefault();

        var dt = e.originalEvent.dataTransfer;
        var files = dt.files;

        handleFiles(files);
      }

      $('#files').on('change', handleFileSelect);

      $("#dropbox").on('dragenter', dragenter);
      $("#dropbox").on('dragover', dragover);
      $("#dropbox").on('drop', drop);

      var boxref = window.location.href;
      $("#box").html(boxref);
      $("#box").attr('href', boxref);

      var box = '#{box}';

      $('.file').on('click', function(e) {
        var id = $(e.target).attr('id');
        var name = $(e.target).html();
        var content = $('#data-' + id).html();
        var decrypt = sjcl.decrypt("password", content);
        window.location = 'data:Application/octet-stream,' + encodeURIComponent(decrypt);
      });
